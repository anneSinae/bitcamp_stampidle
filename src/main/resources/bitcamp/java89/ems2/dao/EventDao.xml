<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="bitcamp.java89.ems2.dao.EventDao">

  <resultMap type="event" id="event-map">
    <id     column="eno"        property="eventNo"/>
    
    <result column="cfno"       property="cafeNo"/>
    <result column="cftel"       property="cafeTel"/>
    <result column="cname"       property="cafeName"/>
    <result column="intro"       property="intro"/>
    <result column="addr"       property="address"/>
    <result column="daddr"       property="detailAddress"/>
    <result column="chair"       property="chairNo"/>
    <result column="logo"       property="logPath"/>
    
    <result column="cmno"       property="cafeMemberNo"/>
    <result column="id"       property="id"/>
    <result column="ctel"       property="cellNo"/>
    <result column="crn"       property="companyNo"/>
    <result column="email"       property="Email"/>
    <result column="pwd"       property="password"/>
    
    <result column="titl"       property="eventTitle"/>
    <result column="econts"     property="eventContents"/>
    <result column="ebirth"     property="registDate"/>
    <result column="epath"      property="eventPhotoPath"/>
    <result column="eview"      property="eventView"/>
    <result column="sday"       property="startDate"/>
    <result column="eday"       property="endDate"/>
  </resultMap>
  
  
  <select id="getList" parameterType="java.util.Map" resultMap="event-map">
    select 
      e.eno,
      e.titl,
      e.econts,
      e.ebirth,
      e.epath,
      e.eview,
      e.sday,
      e.eday,
      c.cname
    from event e
      left outer join cafe c on e.cfno = c.cfno
    where e.cfno=#{cafeMemberNo}
    order by e.eno desc
    limit #{firstPost}, #{postNo}
  </select>
  
  <select id="getListByTitle" parameterType="java.util.Map" resultMap="event-map">
    select 
      e.eno,
      e.titl,
      e.econts,
      e.ebirth,
      e.epath,
      e.eview,
      e.sday,
      e.eday,
      c.cname
    from event e
      left outer join cafe c on e.cfno = c.cfno
    where e.cfno=#{cafeMemberNo} and e.titl like concat('%', #{searchKeyword}, '%')
    order by e.eno desc
    limit #{firstPost}, #{postNo}
  </select>
  
  <select id="getListByCafe" parameterType="java.util.Map" resultMap="event-map">
    select 
      e.eno,
      e.titl,
      e.econts,
      e.ebirth,
      e.epath,
      e.eview,
      e.sday,
      e.eday,
      c.cname
    from event e
      left outer join cafe c on e.cfno = c.cfno
    where e.cfno=#{cafeMemberNo} and c.cname like concat('%', #{searchKeyword}, '%')
    order by e.eno desc
    limit #{firstPost}, #{postNo}
  </select>
  
  <select id="getListByContents" parameterType="java.util.Map" resultMap="event-map">
    select 
      e.eno,
      e.titl,
      e.econts,
      e.ebirth,
      e.epath,
      e.eview,
      e.sday,
      e.eday,
      c.cname
    from event e
      left outer join cafe c on e.cfno = c.cfno
    where e.cfno=#{cafeMemberNo} and e.econts like concat('%', #{searchKeyword}, '%')
    order by e.eno desc
    limit #{firstPost}, #{postNo}
  </select>
  
  <insert id="insert" parameterType="event">
    insert into event(cfno, eno,titl,econts,ebirth,epath,eview,sday,eday) 
    values(
      #{cafeNo},
      #{eventNo},
      #{eventTitle},
      #{eventContents}, 
      #{registDate}, 
      #{eventPhotoPath},
      #{eventView}, 
      #{startDate},
      #{endDate})
  </insert>
  
  
  <update id="updateView" parameterType="int">
    update event
		set eview = eview + 1
		where eno=#{eventNo};
  </update>
  
  
  <update id="update" parameterType="event">
    update event set
      titl=#{eventTitle}, 
      econts=#{eventContents}, 
      ebirth=#{registDate}, 
      sday=#{startDate},
      eday=#{endDate},
      epath=#{eventPhotoPath}
    where eno=#{eventNo}
  </update>
  
  <select id="getOne" resultMap="event-map">
    select 
      e.eno,
      e.titl,
      e.econts,
      e.ebirth,
      e.epath,
      e.eview,
      e.sday,
      e.eday,
      c.cname
    from event e
      left outer join cafe c on e.cfno = c.cfno
    where e.eno=#{value}
  </select>
  
  
  
  
  
  <select id="countByNo" parameterType="int" resultType="int">
    select count(*)
    from event
    where eno=#{value}
  </select>
  
  
  <delete id="delete" parameterType="int">
  <![CDATA[
    delete from event where eno=#{value}
  ]]>
  </delete>
  
  
  
  <select id="getCount" resultType="int">
    select count(*)
    from event
    where cfno=#{cafeMemberNo}
  </select>
  
  
  <select id="getCountByKeyword" parameterType="java.util.Map" resultType="int">
		select count(*)
		    from event e
		left outer join cafe c on e.cfno = c.cfno
    where e.cfno=#{cafeMemberNo} and
    CASE
        WHEN #{searchCondition}="e.titl" THEN  e.titl
        WHEN #{searchCondition}="c.cname" THEN c.cname
        WHEN #{searchCondition}="e.econts" THEN e.econts
        else ''
    END
    like concat('%', #{searchKeyword}, '%')
  </select>
  

</mapper>




