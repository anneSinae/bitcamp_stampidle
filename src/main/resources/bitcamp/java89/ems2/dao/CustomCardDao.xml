<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="bitcamp.java89.ems2.dao.CustomCardDao">

  <resultMap type="customCard" id="customCard-map">
    <id     column="mcno"        property="customCardNo"/>
    
    <result column="birth"       property="cardIssueDate"/>
    <result column="mcuse"       property="cardState"/>
    <result column="death"       property="cardUseDate"/>
    
    <result column="mno"       property="customMemberNo"/>
    <result column="tel"       property="customTel"/>
    <result column="email"       property="customEmail"/>
    <result column="name"       property="customName"/>
    <result column="nick"       property="customNick"/>
    <result column="cphoto"       property="customPhoto"/>
    
    <result column="scno"       property="stampCafeCardNo"/>
    <result column="bpath"       property="backImgPath"/>
    <result column="stnum"       property="stampCount"/>
    <result column="shape"       property="stampImgPath"/>
    
    <collection property="stampList" ofType="stamp">
      <id     column="stno"     property="stampNo"/>
      <result column="many"     property="stampIssueCount"/>
      <result column="stime"     property="stampIssueDate"/>
    </collection>
    
    <collection property="stampPositionList" ofType="stampPosition">
      <id     column="posino"     property="positionNo"/>
      <result column="posix"     property="positionX"/>
      <result column="posiy"     property="positionY"/>
      <result column="stampod"     property="positionOrder"/>
    </collection>
  </resultMap>
  
  
  
  
  <insert id="insert" parameterType="java.util.Map">
    insert into mcard(mno, scno, birth, mcuse) 
    values(#{customMemberNo}, #{stampCafeCardNo}, curdate(), 0)
  </insert>
  
  
  <update id="updatePlusMcuse" parameterType="int">
    UPDATE mcard 
    SET mcuse = 1
    WHERE mcno=#{currentCustomCardNo}
  </update>
  
  
  <update id="updateMinusMcuse" parameterType="int">
    UPDATE mcard 
    SET mcuse = 0
    WHERE mcno=#{usedCustomCardNo}
  </update>
  
  
  <insert id="insertStamp" parameterType="java.util.Map">
    insert into stamp(mcno, many, stime) 
    values(
      (select mcno from mcard
        inner join scinfo on scinfo.scno=mcard.scno
        where mcard.mno=#{customMemberNo} and scinfo.cmno=#{cafeMemberNo}
        order by mcard.mcno desc
        limit 1), 
       #{stampIssueCount}, 
       curdate()
     )
  </insert>
  
  
  
  <select id="getStampList" parameterType="java.util.Map" resultMap="customCard-map">
    select 
      stamp.stno,
      stamp.many,
      stamp.stime,
      memb.mno,
      memb.name,
      memb.tel
    from stamp
      left outer join mcard on stamp.mcno = mcard.mcno
      left outer join memb on mcard.mno = memb.mno
      left outer join scinfo on mcard.scno = scinfo.scno
    	left outer join cafe on scinfo.cmno = cafe.cmno
    where cafe.cmno=#{cafeMemberNo}
      and stamp.stime>=STR_TO_DATE(#{searchFirstDate}, '%Y-%m-%d') 
      and STR_TO_DATE(#{searchLastDate}, '%Y-%m-%d')>=stamp.stime
    order by stamp.stno desc
    limit #{firstPost}, #{postNo}
  </select>
  
  <select id="getStampListByName" parameterType="java.util.Map" resultMap="customCard-map">
    select 
      stamp.stno,
      stamp.many,
      stamp.stime,
      memb.mno,
      memb.name,
      memb.tel
    from stamp
      left outer join mcard on stamp.mcno = mcard.mcno
      left outer join memb on mcard.mno = memb.mno
      left outer join scinfo on mcard.scno = scinfo.scno
    	left outer join cafe on scinfo.cmno = cafe.cmno
    where cafe.cmno=#{cafeMemberNo}
      and stamp.stime>=STR_TO_DATE(#{searchFirstDate}, '%Y-%m-%d') 
      and STR_TO_DATE(#{searchLastDate}, '%Y-%m-%d')>=stamp.stime
      and memb.name like concat('%', #{searchKeyword}, '%')
    order by stamp.stno desc
    limit #{firstPost}, #{postNo}
  </select>
  
  <select id="getStampListByTel" parameterType="java.util.Map" resultMap="customCard-map">
    select 
      stamp.stno,
      stamp.many,
      stamp.stime,
      memb.mno,
      memb.name,
      memb.tel
    from stamp
      left outer join mcard on stamp.mcno = mcard.mcno
      left outer join memb on mcard.mno = memb.mno
      left outer join scinfo on mcard.scno = scinfo.scno
    	left outer join cafe on scinfo.cmno = cafe.cmno
    where cafe.cmno=#{cafeMemberNo}
      and stamp.stime>=STR_TO_DATE(#{searchFirstDate}, '%Y-%m-%d') 
      and STR_TO_DATE(#{searchLastDate}, '%Y-%m-%d')>=stamp.stime
      and memb.tel like concat('%', #{searchKeyword}, '%')
    order by stamp.stno desc
    limit #{firstPost}, #{postNo}
  </select>
  
  
  <select id="getStampCount" parameterType="java.util.Map" resultType="int">
    select count(*)
    from stamp
    	left outer join mcard on stamp.mcno = mcard.mcno
    	left outer join scinfo on mcard.scno = scinfo.scno
    	left outer join cafe on scinfo.cmno = cafe.cmno
    where cafe.cmno=#{cafeMemberNo} 
      and stamp.stime>=STR_TO_DATE(#{searchFirstDate}, '%Y-%m-%d') 
      and STR_TO_DATE(#{searchLastDate}, '%Y-%m-%d')>=stamp.stime
  </select>
  
  
  <select id="getStampCountByKeyword" parameterType="java.util.Map" resultType="int">
		select count(*)
		from stamp
    	left outer join mcard on stamp.mcno = mcard.mcno
    	left outer join memb on mcard.mno = memb.mno
    	left outer join scinfo on mcard.scno = scinfo.scno
    	left outer join cafe on scinfo.cmno = cafe.cmno
    where cafe.cmno=#{cafeMemberNo}
      and stamp.stime>=STR_TO_DATE(#{searchFirstDate}, '%Y-%m-%d') 
      and STR_TO_DATE(#{searchLastDate}, '%Y-%m-%d')>=stamp.stime
      and
        CASE
        WHEN #{searchCondition}="memb.name" THEN  memb.name
        WHEN #{searchCondition}="memb.tel" THEN memb.tel
        else ''
        END
        like concat('%', #{searchKeyword}, '%')
  </select>
  
  
  <select id="getCustomDetail" parameterType="java.util.Map" resultMap="customCard-map">
	select
	  memb.cphoto,
	  memb.name,
	  memb.tel,
	  mcard.mcno,
	  mcard.birth,
	  mcard.mcuse,
	  stamp.stno,
	  stamp.many,
	  stamp.stime,
	  scinfo.stnum
	from memb
	  left outer join mcard on memb.mno=mcard.mno
	  left outer join stamp on stamp.mcno=mcard.mcno
	  left outer join scinfo on scinfo.scno=mcard.scno
	where scinfo.cmno=#{cafeMemberNo}
	  and memb.mno=#{customMemberNo}
	order by mcard.mcno asc 
  </select>
  
   <select id="getCustomCardDetail" parameterType="java.util.Map" resultMap="customCard-map">
	  select
		  mcard.mcuse,
		  stamp.stno,
		  stamp.many,
		  stamp.mcno
		from mcard
			left outer join scinfo on scinfo.scno=mcard.scno
			left outer join stamp on mcard.mcno=stamp.mcno
		where scinfo.cmno=#{cafeMemberNo} and mcard.mno=#{customMemberNo}
  </select>
  
  <select id="getCardDetail" parameterType="java.util.Map" resultMap="customCard-map">
  select
    mcard.mcno,
	  stposi.posix, 
	  stposi.posiy, 
	  stposi.stampod, 
	  scinfo.bpath, 
	  scinfo.stnum,
	  scinfo.shape
	from mcard
		inner join scinfo on mcard.scno=scinfo.scno
		inner join stposi on stposi.scno=scinfo.scno
	where scinfo.cmno=#{cafeMemberNo} and mcard.mno=#{customMemberNo}
  </select>
  
  
  
  <select id="getList" parameterType="java.util.Map" resultMap="customCard-map">
	select
	  mcard.mno,
	  memb.name,
	  memb.tel,
	  memb.email,
	  mcard.mcno
	from memb
	  left outer join mcard on memb.mno=mcard.mno
	  left outer join scinfo on mcard.scno=scinfo.scno
	  left outer join cafe on scinfo.cmno=cafe.cmno
	where
	  cafe.cmno=#{cafeMemberNo}
	group by mcard.mno
	order by mcard.mno desc, mcard.birth desc
  </select>
  
  <select id="getListSelect" parameterType="java.util.Map" resultMap="customCard-map">
  select
    mcard.mno,
    memb.name,
    memb.tel,
    memb.email,
    mcard.mcno
  from memb
    left outer join mcard on memb.mno=mcard.mno
    left outer join scinfo on mcard.scno=scinfo.scno
    left outer join cafe on scinfo.cmno=cafe.cmno
  where
    cafe.cmno=#{cafeMemberNo}
  group by mcard.mno
  order by #{selectCafeList}
  </select>
  
  
  <select id="getStampCafeCardNo" parameterType="int" resultType="int">
  select
    scinfo.scno
  from scinfo
  where cmno=#{cafeMemberNo}
  order by scinfo.scno desc
  limit 1
  </select>
  
  
  

</mapper>




